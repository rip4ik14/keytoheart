# Performance snippets for Next.js (keytoheart.ru)
# Include in the TLS server block that proxies requests to Next.js.

# 1) Immutable static assets generated by Next
location ^~ /_next/static/ {
  add_header Cache-Control "public, max-age=31536000, immutable" always;
  expires 1y;
  proxy_pass http://127.0.0.1:3000;
}

# 2) Fonts/icons/uploads from public/
location ~* ^/(fonts|icons|uploads)/ {
  add_header Cache-Control "public, max-age=31536000, immutable" always;
  expires 1y;
  proxy_pass http://127.0.0.1:3000;
}

# 3) Next image optimizer cache
location = /_next/image {
  add_header Cache-Control "public, max-age=86400, stale-while-revalidate=604800" always;
  proxy_pass http://127.0.0.1:3000;
}

# 4) Text compression
gzip on;
gzip_comp_level 5;
gzip_min_length 1024;
gzip_vary on;
gzip_proxied any;
gzip_types
  text/plain
  text/css
  text/xml
  text/javascript
  application/javascript
  application/x-javascript
  application/json
  application/xml
  application/xml+rss
  application/rss+xml
  image/svg+xml;

# Brotli if module is available
brotli on;
brotli_comp_level 5;
brotli_static on;
brotli_types
  text/plain
  text/css
  text/xml
  text/javascript
  application/javascript
  application/json
  application/xml
  image/svg+xml;
